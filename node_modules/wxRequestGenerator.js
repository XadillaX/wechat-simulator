/**
 * Created with JetBrains WebStorm.
 * User: XadillaX
 * Date: 13-10-11
 * Time: 下午8:18
 * wechat request generator.
 */
var utils = require("wxutils");
var querystring = require("querystring");

function wxRequestGenerator(baseurl, token) {
    this.baseurl = baseurl;
    this.token = token;
    this.spider = require("nodegrassex");
}

exports.create = function(baseurl, token) {
    return new wxRequestGenerator(baseurl, token);
};

wxRequestGenerator.prototype.verifyUrl = function(callback) {
    /**
     * Callback format:
     *
     *     function callback(status, msg) { ... }
     */

    var self = this;
    var url = this.genUrl(true);
    this.spider.get(url, function(data, status, resp) {
        if(status !== 200) {
            callback(false, "The server sent a wrong status " + status + ".");
            return;
        }

        if(data !== self._echostr) {
            callback(false, "The server sent a wrong echostr \"" + data + "\" (origin echostr: " + this._echostr + ").");
            return;
        }

        callback(true, "");
    }, "utf8").on("error", function(e) {
        callback(false, e.message);
    });
};

wxRequestGenerator.prototype.genUrl = function(isTest) {
    var timestamp = utils.getTimestamp();
    var nonce = utils.rand(2147483647);
    var token = this.token;
    var signature = utils.createSignature(timestamp, nonce, token);
    var query = {
        "timestamp"     : timestamp,
        "nonce"         : nonce,
        "signature"     : signature,
        "token"         : token
    };
    if(isTest !== undefined && isTest === true) {
        query["echostr"] = utils.createEchostr();
    }

    var qs = querystring.stringify(query);
    var url = this.baseurl + "?" + qs;

    if(isTest) this._echostr = query["echostr"];

    return url;
};
